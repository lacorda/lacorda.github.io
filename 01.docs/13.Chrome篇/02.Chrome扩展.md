


import Admonition from '@theme/Admonition';

## 什么是Chrome扩展
`Chrome Extension`：Chrome扩展，又叫Chrome插件，是用Web技术开发、用来增强浏览器功能，由HTML、CSS、JS、图片等资源组成的一个`.crx`后缀的压缩包

`crx`的简写来源于`Chrome Extension`<img src="http://image.liuxianan.com/201706/20170619_114836_364_3616.png" width="200" />

此外，不只是前端技术，Chrome插件还可以配合`C++`编写的`dll`动态链接库实现一些更底层的功能(`NPAPI`(由于安全原因，Chrome浏览器42以上版本已经陆续不再支持NPAPI插件，取而代之的是更安全的`PPAPI`))，比如全屏幕截图。

[官方文档 - v2](https://developer.chrome.com/docs/extensions/mv2/manifest/)

[官方文档 - v3](https://developer.chrome.com/docs/extensions/mv3/manifest/)

本文以v3为准，v3是基于Chrome88以上版本生效

## 必需文件

### 一、manifest.json清单文件

#### 必需配置

##### 1.manifest_version
清单文件的版本，当前为v3版本

<Admonition type="note" icon="👉" title="https://developer.chrome.com/docs/extensions/mv3/intro/mv3-overview/">
  <p>清单 V3 在 Chrome 88 或更高版本中通常受支持。有关更高版本的 Chrome 中添加的扩展功能，请参阅 API 参考文档以获取支持信息。如果您的扩展需要特定的 API，您可以在清单文件中指定最低 chrome 版本。</p>
</Admonition>


```json
{
  "manifest_version": 3
}
```

##### 2.name插件名称
```json
{
  "name": "Demo"
}
```

##### 3.version插件版本
> 1-4个点分隔的整数，标识此扩展的版本

```json
{
  "version": "1.0.0"
}
```

#### 插件展示相关配置

##### 1.description插件描述
> 这个插件干什么用的

```json
{
  "description": "简单的Chrome扩展demo"
}
```

##### 2.icon插件图标
分3种图标：
- 128x128: 安装期间和Chrome网上应用店使用
- 48x48: 扩展管理页(`chrome://extensions`)中使用
- 16x16: 工具栏上显示的图标


<Admonition type="note" icon="👉" title="https://developer.chrome.com/docs/extensions/mv2/manifest/icons/">
  <p>您可以提供所需的任何其他尺寸的图标，Chrome 会在适当的情况下尝试使用最佳尺寸。例如，Windows 通常需要 32 像素图标，如果应用包含 32 像素图标，Chrome 将选择该图标，而不是缩小 48 像素图标。但是，您应确保所有图标都是方形的，否则可能会导致意外行为。</p>
  <p></p>
  <p>如果您使用 [Chrome 开发者信息中心](https://chrome.google.com/webstore/developer/dashboard) 上传扩展程序、应用或主题背景，则需要上传其他图片，包括至少一张扩展程序的屏幕截图。有关详情，请参阅 [Chrome 网上应用店开发者文档](https://developer.chrome.com/docs/webstore/)。</p>
</Admonition>


图标可以是WebKit支持的任何格式，包括BMP，GIF，ICO和JPEG，但通常应采用`PNG`格式最佳

```json
{
  "icons": { 
    "16": "icon16.png",
    "48": "icon48.png",
    "128": "icon128.png"
  }
}
```


##### 3.action
> 控制扩展程序的工具栏按钮，对应v2版本的`browser_action`。

包含3个部分：
- `default_icon`: 工具栏按钮中使用的图标，可选，可以是对象，也可以是字符串。未填则使用`icons.16`
- `default_title`: 图标悬停时的标题，可选
- `default_popup`: 点击图标出现的弹出窗口，可选，是个`html`文件路径


```json
{
  "action": {
    // "default_icon": "images/icon16.png",   // optional
    "default_icon": {              // optional
      "16": "images/icon16.png",   // optional
      "24": "images/icon24.png",   // optional
      "32": "images/icon32.png"    // optional
    },
    "default_title": "Click Me",   // optional, shown in tooltip
    "default_popup": "popup.html"  // optional
  }
}
```


##### 4.default_locale默认语言

```json
{
	"default_locale": "zh_CN",
}
```


#### 其他配置

##### 1.background
> 后台的脚本


```json
{
  "background": {
		// 2种指定方式，如果指定JS，那么会自动生成一个背景页
		"page": "background.html",
		//"scripts": ["js/background.js"]

    "service_worker": "service-worker.js",
    "type": "module",
  }
}
```


background的权限非常高，几乎可以调用所有的Chrome扩展API（除了devtools），而且它可以无限制跨域，也就是可以跨域访问任何网站而无需要求对方设置CORS。

经过测试，其实不止是background，所有的直接通过chrome-extension://id/xx.html这种方式打开的网页都可以无限制跨域。

配置中，background可以通过page指定一张网页，也可以通过scripts直接指定一个JS，Chrome会自动为这个JS生成一个默认的网页：


##### 2.content_scripts标签页执行的脚本
> 标签页执行的脚本。是个数组，指定每次打开与`特定 URL 模式匹配`的页面时要使用的静态加载的 `JavaScript` 或 `CSS` 文件。

每个指定的Url配置，包含以下配置：
- 匹配网址
  - `matches`: 必填，数组，匹配将内容脚本注入到的网址
  - `exclude_matches`: 可选，数组，排除网址
  - `include_globs`: 可选，数组，在匹配后应用，以仅包含与此 glob 匹配的那些 URL
  - `exclude_globs`: 可选，数组，在匹配后应用以排除与此 glob 匹配的 URL


- 运行时和执行环境
  - `run_at`: 何时应将脚本注入页面。它对应于 Document.readyState 的加载状态：
    - `document_start` ：DOM 仍在加载。
    - `document_end` ：页面的资源仍在加载中
    - `document_idle` ：DOM 和资源已完成加载，默认值

- 注入的js和css
  - `js`: 数组，多个js按顺序注入
  - `css`: 数组，多个css按顺序加载

[更多见官方文档](https://developer.chrome.com/docs/extensions/mv3/manifest/content_scripts/)

```json
{
  "content_scripts": [
   {
     "matches": ["https://*.example.com/*"],
     "css": ["my-styles.css"],
     "js": ["content-script.js"],
     "exclude_matches": ["*://*/*foo*"],
     "include_globs": ["*example.com/???s/*"],
     "exclude_globs": ["*bar*"],     
     "all_frames": false,
     "match_origin_as_fallback": false,
     "match_about_blank": false,
     "run_at": "document_idle",
     "world": "ISOLATED",
   }
 ]
}
```

##### 3.permissions权限/API申请
[权限列表见官方文档](https://developer.chrome.com/docs/extensions/mv3/declare_permissions/#permissions)

```json title=常用的权限
{
  "permissions": [
		"tabs", // 允许与标签页的交互：获取有关打开的标签页的信息，控制标签页的行为，以及在标签页之间进行通信。
		"contextMenus", // 右键菜单
		"notifications", // 通知
		"webRequest", // web请求
		// "webRequestBlocking",  // 阻止web请求
		"storage", // 插件本地存储
		"http://*/*", // 可以通过executeScript或者insertCSS访问的网站
		"https://*/*" // 可以通过executeScript或者insertCSS访问的网站
	]
}
```

#### 其它配置

##### author作者

```json
{
  "author": "developer@example.com"
}
```

##### homepage_url主页

```json
{
  "homepage_url": "https://www.baidu.com"
}
```


##### optional_permissions运行时加载的权限申请
[见官方文档](https://developer.chrome.com/docs/extensions/reference/permissions/#step-2-declare-optional-permissions-in-the-manifest)


##### 更多

```json
{
  // 普通页面能够直接访问的插件资源列表，如果不设置是无法直接访问的
	"web_accessible_resources": ["js/inject.js"],
	// 覆盖浏览器默认页面
	"chrome_url_overrides":
	{
		// 覆盖浏览器默认的新标签页
		"newtab": "newtab.html"
	},
	// 插件配置页面（右键 - 选项）
	"options_page": "options.html",
	// Chrome40以后的插件配置页写法，如果2个都写，新版Chrome只认后面这一个
	"options_ui":
	{
		"page": "options.html",
		// 添加一些默认的样式，推荐使用
		"chrome_style": true
	},
	// 向地址栏注册一个关键字以提供搜索建议，只能设置一个关键字
	"omnibox": { "keyword" : "go" },
	// 默认语言
	"default_locale": "zh_CN",
	// devtools页面入口，注意只能指向一个HTML文件，不能是JS文件
	"devtools_page": "devtools.html"
}
```



## 联调
[chrome调试技巧](https://blog.spoock.com/2016/04/03/chrome-extension-debugging/)

## API

### 1.chrome.tabs
[官方文档](https://developer.chrome.com/docs/extensions/reference/tabs/)


> chrome.tabs 是 Chrome 扩展开发中的一个 API，它允许你与浏览器标签页进行交互。通过这个 API，你可以获取有关打开的标签页的信息，控制标签页的行为，以及在标签页之间进行通信。

常用的API功能有：
1. 获取标签页信息：

`chrome.tabs.query(queryInfo, callback)`: 查询匹配条件的标签页，并在回调中获取相关信息。[tabs.query](https://developer.chrome.com/docs/extensions/reference/tabs/#method-query)

`chrome.tabs.get(tabId, callback)`: 获取指定标签页的详细信息。


2. 创建和关闭标签页：

`chrome.tabs.create(createProperties, callback)`: 创建一个新的标签页。

`chrome.tabs.remove(tabId / tabIds, callback)`: 关闭一个或多个标签页。


3. 更新标签页属性：

`chrome.tabs.update(tabId, updateProperties, callback):` 更新指定标签页的属性，如 URL、激活状态等。


4. 在标签页之间通信：

`chrome.tabs.sendMessage(tabId, message, options, callback)`: 向指定标签页发送消息，用于内容脚本和扩展之间的通信。

`chrome.tabs.onMessage`: 用于侦听在标签页之间发送的消息。


5. 操控标签页行为：

`chrome.tabs.executeScript(tabId, details, callback)`: 在指定标签页中执行 JavaScript 脚本。

`chrome.tabs.insertCSS(tabId, details, callback)`: 在指定标签页中插入 CSS 样式。


### 2.chrome.runtime运行时
> 它允许你在扩展的不同组件（如`background scripts`、`content scripts`、`popup` 页面等）之间进行**通信**，以及提供一些有关扩展自身信息的方法和属性。

以下是一些常见的 chrome.runtime API 功能：

1. 获取扩展信息：

`chrome.runtime.getManifest()`: 获取扩展的清单文件（manifest.json）中的信息，如名称、版本等。


2. 消息通信：

`chrome.runtime.sendMessage(message, callback)`: 在不同的组件之间发送消息。可以用于从 popup 页面、content script 或 background script 发送消息。

`chrome.runtime.onMessage`: 用于监听来自其他组件的消息。


3. 设置扩展图标徽章：

`chrome.runtime.setBadgeText(details)`: 在扩展图标上显示文本徽章。

`chrome.runtime.setBadgeBackgroundColor(details)`: 设置扩展图标上徽章的背景颜色。


4. 管理权限请求：

`chrome.runtime.requestPermissions(permissions, callback)`: 请求特定的权限。


5. 管理扩展生命周期：

`chrome.runtime.onInstalled`: 用于监听扩展的安装事件。

`chrome.runtime.onStartup`: 用于监听扩展的启动事件。


6. 获取扩展 ID 和 URL：

`chrome.runtime.id`: 获取当前扩展的唯一 ID。

`chrome.runtime.getURL(path)`: 将相对路径转换为扩展内部的绝对 URL。


chrome.runtime API 允许你在扩展的不同部分之间进行有效的通信，并提供一些关于扩展的元数据和功能的信息。在Chrome扩展开发中，你会经常使用这个 API 来管理你的扩展的行为，处理通信，以及获取必要的信息。