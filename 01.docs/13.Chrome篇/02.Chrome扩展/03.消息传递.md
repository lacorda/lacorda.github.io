
这部分将从三个方面介绍消息传递：

- 插件内部的通讯
- 插件与插件之间的通讯
- 插件与页面之间的通讯

同时，穿插介绍`background`、`content`的特殊性


## 1. 插件内部的通讯

<!-- ### background与content之间的通讯

:::tip `content`的特殊性
1. 一个独立于页面的脚本，它的生命周期与页面保持一致，刷新页面后，`content`会重新加载
2. 因为它是在页面中运行的，所以可以直接操作页面的`DOM`
::: -->

### background监听事件

:::tip `background`的特殊性
1. 一个长期运行的后台脚本，它的生命周期与浏览器保持一致，即使没有打开任何`Tab`页，`background`也会一直运行
2. 没有生命周期的限制，所以常用于事件监听
3. 无法使用`DOM`操作，因为没有`DOM`环境
:::

#### 安装事件

```js
// 监听安装事件
chrome.runtime.onInstalled.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听安装事件', Date.now(), details);
  if (details.reason === 'install') {
    await MessageStorage.setProperty({
      install: {
        from: 'background'
      }
    });

    // 安装完成后打开新页面
    // chrome.tabs.create({
    //   url: path
    // });
  }
});
```

#### 卸载事件

```js
// 监听卸载事件
chrome.runtime.onUninstalled.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听卸载事件', Date.now(), details);
  if (details.reason === 'uninstall') {
    await MessageStorage.setProperty({
      uninstall: {
        from: 'background'
      }
    });
  }
});
```

#### 更新事件

```js
// 监听更新事件
chrome.runtime.onUpdateAvailable.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听更新事件', Date.now(), details);
  if (details.reason === 'update') {
    await MessageStorage.setProperty({
      update: {
        from: 'background'
      }
    });
  }
});
```

#### 启动事件

```js
// 监听启动事件
chrome.runtime.onStartup.addListener(async () => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听启动事件', Date.now());
});
```

#### 连接事件

```js
// 监听连接事件
chrome.runtime.onConnect.addListener(async (port) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听连接事件', Date.now(), port);
});
```

#### 消息事件

```js
// 监听消息事件
chrome.runtime.onMessage.addListener(async (message, sender, sendResponse) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听消息事件', Date.now(), message, sender, sendResponse);
});
```

#### 通讯事件

```js
// 监听通讯事件
chrome.runtime.onMessageExternal.addListener(async (message, sender, sendResponse) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听通讯事件', Date.now(), message, sender, sendResponse);
});
```

#### 通讯端口事件

```js
// 监听通讯端口事件
chrome.runtime.onConnectExternal.addListener(async (port) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听通讯端口事件', Date.now(), port);
});
```

#### 网络请求事件

```js
// 监听网络请求事件
chrome.webRequest.onBeforeRequest.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求事件', Date.now(), details);
});

// 监听网络请求错误事件
chrome.webRequest.onErrorOccurred.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求错误事件', Date.now(), details);
});

// 监听网络请求完成事件
chrome.webRequest.onCompleted.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求完成事件', Date.now(), details);
});

// 监听网络请求发送事件
chrome.webRequest.onSendHeaders.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求发送事件', Date.now(), details);
});

// 监听网络请求响应事件
chrome.webRequest.onHeadersReceived.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求响应事件', Date.now(), details);
});

// 监听网络请求重定向事件
chrome.webRequest.onBeforeRedirect.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求重定向事件', Date.now(), details);
});

// 监听网络请求认证事件
chrome.webRequest.onAuthRequired.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求认证事件', Date.now(), details);
});

// 监听网络请求代理认证事件
chrome.webRequest.onAuthRequired.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求代理认证事件', Date.now(), details);
});

// 监听网络请求Cookie事件
chrome.webRequest.onCookieChange.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求Cookie事件', Date.now(), details);
});

// 监听网络请求缓存事件
chrome.webRequest.onCompleted.addListener(async (details) => {
  console.log('🍄  background: >>>>>>>>>>>>>>>>>> 监听网络请求缓存事件', Date.now(), details);
});
```
