
è¿™éƒ¨åˆ†å°†ä»ä¸‰ä¸ªæ–¹é¢ä»‹ç»æ¶ˆæ¯ä¼ é€’ï¼š

- æ’ä»¶å†…éƒ¨çš„é€šè®¯
- æ’ä»¶ä¸æ’ä»¶ä¹‹é—´çš„é€šè®¯
- æ’ä»¶ä¸é¡µé¢ä¹‹é—´çš„é€šè®¯

åŒæ—¶ï¼Œç©¿æ’ä»‹ç»`background`ã€`content`çš„ç‰¹æ®Šæ€§


## 1. æ’ä»¶å†…éƒ¨çš„é€šè®¯

:::tip 
`background`çš„ç‰¹æ®Šæ€§:
1. ä¸€ä¸ªé•¿æœŸè¿è¡Œçš„åå°è„šæœ¬ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸æµè§ˆå™¨ä¿æŒä¸€è‡´ï¼Œå³ä½¿æ²¡æœ‰æ‰“å¼€ä»»ä½•`Tab`é¡µï¼Œ`background`ä¹Ÿä¼šä¸€ç›´è¿è¡Œ
2. æ²¡æœ‰ç”Ÿå‘½å‘¨æœŸçš„é™åˆ¶ï¼Œæ‰€ä»¥å¸¸ç”¨äºäº‹ä»¶ç›‘å¬
3. æ— æ³•ä½¿ç”¨`DOM`æ“ä½œï¼Œå› ä¸ºæ²¡æœ‰`DOM`ç¯å¢ƒ

`content`çš„ç‰¹æ®Šæ€§:
1. ä¸€ä¸ªç‹¬ç«‹äºé¡µé¢çš„è„šæœ¬ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸä¸é¡µé¢ä¿æŒä¸€è‡´ï¼Œåˆ·æ–°é¡µé¢åï¼Œ`content`ä¼šé‡æ–°åŠ è½½
2. å› ä¸ºå®ƒæ˜¯åœ¨é¡µé¢ä¸­è¿è¡Œçš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ“ä½œé¡µé¢çš„`DOM`
:::

:::danger 
æŠ¥é”™: Uncaught (in promise) Error: Could not establish connection. Receiving end does not exist.
æŠ¥é”™åŸå› : sendMessageæ—¶ï¼Œæ²¡æœ‰æ¥æ”¶æ–¹ã€‚å¯èƒ½åŸå› :
1. æ¥æ”¶æ–¹æ²¡æœ‰æ³¨å†Œ`onMessage/onConnect`äº‹ä»¶
2. æ¥æ”¶æ–¹æœªåŠ è½½ï¼Œå¦‚`content`æœªåŠ è½½ã€`popup`æœªæ‰“å¼€
:::

### background
> æ¥æ”¶å¤„ç†æ¶ˆæ¯ã€ç›‘å¬æ’ä»¶ä¸æµè§ˆå™¨çš„ç”Ÿå‘½å‘¨æœŸ

```js
// æ¥æ”¶æ¥è‡ªæ’ä»¶å†…éƒ¨çš„æ¶ˆæ¯
chrome.runtime.onMessage.addListener(async (message, sender, sendResponse) => {
  console.log('ğŸ„  ', message, sender, sendResponse);
});

// å»ºç«‹é•¿è¿æ¥æ—¶è§¦å‘
chrome.runtime.onConnect.addListener(function (port) {
  // ç›‘å¬ content,popup å‘é€çš„æ¶ˆæ¯
  port.onMessage.addListener(function (msg) {
    console.log('ğŸ„  ',  port, msg);
    if (port.name === 'xxx') {
      port.postMessage({ from: 'background' });
    }
  });
});

// ç›‘å¬å®‰è£…äº‹ä»¶
chrome.runtime.onInstalled.addListener(async (details) => {
  console.log('ğŸ„  ', details);
  if (details.reason === 'install') {
    await MessageStorage.setProperty({
      install: {
        from: 'background'
      }
    });

    // å®‰è£…å®Œæˆåæ‰“å¼€æ–°é¡µé¢
    chrome.tabs.create({
      url: path
    });
  }
});

// ç›‘å¬å¸è½½äº‹ä»¶
chrome.runtime.onUninstalled.addListener(async (details) => {
  console.log('ğŸ„   ç›‘å¬å¸è½½äº‹ä»¶', Date.now(), details);
  if (details.reason === 'uninstall') {
    // ...
  }
});

// ç›‘å¬å¯åŠ¨äº‹ä»¶
chrome.runtime.onStartup.addListener(async () => {
  console.log('ğŸ„   ç›‘å¬å¯åŠ¨äº‹ä»¶', Date.now());
});
```

### content
> è§¦å‘æ¥æ”¶äº‹ä»¶

```js
// æ¥æ”¶popupäº‹ä»¶ã€è§¦å‘äº‹ä»¶
chrome.runtime.onMessage.addListener((msg) => {
  console.log('ğŸ„  æ¥æ”¶popup', msg);
  chrome.runtime.sendMessage(msg, (response) => {
    console.log('ğŸ„  è§¦å‘äº‹ä»¶', Date.now(), response);
  });
})

// å»ºç«‹é•¿é“¾æ¥ã€å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¶ˆæ¯
const port = chrome.runtime.connect({ name: "from-content" });
port.postMessage({ from: "content 0" });
port.onMessage.addListener((msg) => {
  console.log('ğŸ„  ', port, msg);
  if (msg.from === "background") {
    port.postMessage({ from: "content", data: 'content 1' });
  } else if (msg.from === "popup") {
    port.postMessage({ from: "content", data: 'content 2' });
  }
});
```

### popup
> è§¦å‘æ¥æ”¶äº‹ä»¶

```js
// æ¥æ”¶contentäº‹ä»¶
chrome.runtime.onMessage.addListener((msg) => {
  console.log('ğŸ„  æ¥æ”¶content', msg);
});
// è§¦å‘äº‹ä»¶
chrome.runtime.sendMessage({ type: 'geo' });

// å»ºç«‹é•¿é“¾æ¥ã€å‘é€æ¶ˆæ¯ã€æ¥æ”¶æ¶ˆæ¯
const port = chrome.runtime.connect({ name: "from-popup" });
port.postMessage({ from: "popup" });
port.onMessage.addListener(function (msg) {
  if (msg.from === "background") {
    port.postMessage({ from: "popup", data: 'popup 0' });
  } else if (msg.from === "content") {
    port.postMessage({ from: "popup", data: 'popup 1' });
  }
});
```

## 2. æ’ä»¶ä¸æ’ä»¶ä¹‹é—´çš„é€šè®¯

### æ’ä»¶A å‘é€æ¶ˆæ¯

```js
// éœ€è¦å‘é€åˆ°çš„æ’ä»¶çš„id
const receivedExtensionId = "abcdefghijklmnoabcdefhijklmnoabc";

// å•æ¬¡æ¶ˆæ¯
chrome.runtime.sendMessage(receivedExtensionId, { from: "a" }, (response) => {
  console.log('ğŸ„  ', response);
});

// é•¿è¿æ¥
var port = chrome.runtime.connect(receivedExtensionId);
port.postMessage({ from: "a" });
```

### æ’ä»¶B æ¥æ”¶æ¶ˆæ¯

```js
// æ¥æ”¶æ¶ˆæ¯
chrome.runtime.onMessageExternal.addListener((request, sender, sendResponse) => {
    if (request.from === "a") {
      sendResponse({targetData: "b"});
    }
  }
);

// æ¥æ”¶é•¿è¿æ¥
chrome.runtime.onConnectExternal.addListener((port) => {
  port.onMessage.addListener((msg) => {
    if (msg.from === "a") {
      port.postMessage({targetData: "b"});
    }
  });
});
```

## 3. æ’ä»¶ä¸é¡µé¢ä¹‹é—´çš„é€šè®¯

:::tip å…³äºæ’ä»¶ID
1. æ’ä»¶IDè·å–:
   - `chrome://extensions/` -> æŸ¥çœ‹æ’ä»¶ID
   - æ’ä»¶ä¸­é€šè¿‡`chrome.runtime.id`è·å–
2. æ’ä»¶IDè‹¥æœªå‘å¸ƒåˆ°`Chrome Web Store`ï¼Œä½¿ç”¨å¼€å‘è€…æ¨¡å¼åŠ è½½æ’ä»¶æ—¶ï¼Œæ’ä»¶IDä¼šå˜åŒ–ã€‚æ•…: æœªå‘å¸ƒçš„æ’ä»¶ï¼Œä¸è¦ä½¿ç”¨ External æ–¹å¼
:::


### é€šè¿‡External

#### æƒé™é…ç½®
```json
{
  "externally_connectable": {
    "matches": [
      "localhost:*/*",
      "*://localhost/*",
      "*://*.iyb.com/*",
    ],
  },
}
```

#### é¡µé¢ å‘é€æ¶ˆæ¯

```js
// éœ€è¦å‘é€åˆ°çš„æ’ä»¶çš„id
const receivedExtensionId = "abcdefghijklmnoabcdefhijklmnoabc";

// å•æ¬¡æ¶ˆæ¯
chrome.runtime.sendMessage(receivedExtensionId, { from: "a" }, (response) => {
  console.log('ğŸ„  ', response);
});

// é•¿è¿æ¥
var port = chrome.runtime.connect(receivedExtensionId);
port.postMessage({ from: "a" });
```

#### æ’ä»¶ æ¥æ”¶æ¶ˆæ¯

```js
// æ¥æ”¶æ¶ˆæ¯
chrome.runtime.onMessageExternal.addListener((request, sender, sendResponse) => {
    if (request.from === "a") {
      sendResponse({targetData: "b"});
    }
  }
);

// æ¥æ”¶é•¿è¿æ¥
chrome.runtime.onConnectExternal.addListener((port) => {
  port.onMessage.addListener((msg) => {
    if (msg.from === "a") {
      port.postMessage({targetData: "b"});
    }
  });
});
```

### é€šè¿‡window.postMessage

#### é¡µé¢ å‘é€æ¶ˆæ¯

```js
window.postMessage({
  source: "webPage",
  type: "message",
  data: "hello"
}, "*");
```

#### æ’ä»¶content æ¥æ”¶æ¶ˆæ¯
> åªæœ‰åœ¨æ’ä»¶`content`ä¸­æ‰èƒ½æ¥æ”¶åˆ°`window`æ¶ˆæ¯ã€‚æ³¨: 
> 1. `background`ä¸­æ— æ³•æ¥æ”¶`window`
> 2. é¡µé¢ä¸­çš„`window.postMessage`å¿…é¡»åœ¨`content`åŠ è½½å®Œæˆä¹‹åæ‰èƒ½å‘é€

```js
window.addEventListener("message", function (event) {
  if (event.source !== window) return;
  if (event.data.source === "webPage") {
    console.log('ğŸ„  ', event.data);

    // å‘popupå‘é€æ¶ˆæ¯
    chrome.runtime.sendMessage({ from: "content", data: 'content 0' });
  }
}, false);
```
